variables:
  APP_NAME: app
  SRC_PATH: ""
  GO_TEST_VERSION: "1.10"
  IMAGE_NAME: app

unit-test:
  stage: test
  image: golang:${GO_TEST_VERSION}
  script:
  - ln -s `pwd` /go/src/${APP_NAME}
  - cd /go/src/${APP_NAME}/${SRC_PATH} && go get && go test

build-master-image:
  stage: build
  image: gcr.io/cloud-solutions-images/kaniko
  only:
  - master
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - executor -f `pwd`/${SRC_PATH}/Dockerfile -c `pwd`/${SRC_PATH} --destination="${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
