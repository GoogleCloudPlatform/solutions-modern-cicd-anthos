deploy-staging-us-central1:
  # Only deploy to staging env from $APP-env staging branch, kicking off rollout 
  only:
    refs:
      - staging
  stage: deploy-staging-us-central1
  image: gcr.io/cloud-builders/gke-deploy:stable
  tags:
  - cluster:staging-us-central1
  script:
  - /gke-deploy run --filename kustomize-stg.yaml
  
deploy-prod-us-east1:
  # Only deploy when running on master in $APP-env
  only:
    refs:
      - master
  stage: deploy-prod-us-east1
  image: gcr.io/cloud-builders/gke-deploy:stable
  tags:
  - cluster:prod-us-east1
  script:
  - /gke-deploy run --filename kustomize-prod.yaml

deploy-prod-us-central1:
  # Only deploy when running on master in $APP-env
  only:
    refs:
      - master
  stage: deploy-prod-us-central1
  image: gcr.io/cloud-builders/gke-deploy:stable
  tags:
  - cluster:prod-us-central1
  script:
  - |
  - /gke-deploy run --filename kustomize-prod.yaml

rollout-delay:
  # Only deploy when running on master in $APP-env
  only:
    refs:
      - master
  stage: rollout-delay
  script: echo 'Delaying rollout for 2 minutes to let the deploy settle'
  when: delayed
  start_in: 2 minutes
